@page "/login"
@using System.IO
@using System.Net.Http
@using System.Text.Json
@using Microsoft.AspNetCore.Http
@using SilverBotDS.Objects
@using SilverBotDS.Objects.Classes
@using SilverBotDS.WebHelpers
@inject IHttpContextAccessor _httpContextAccessor
@inject Config _config
@inject HttpClient _client
@{
    var code = Request.Query["code"].ToString();
    if (string.IsNullOrEmpty(code))
    {
        Response.Redirect(_config.LoginPageDiscordRedirectUrl);
    }
    else
    {
        //stolen from https://www.yogihosting.com/discord-api-asp-net/
        var redirectUrl = $"https://{Request.Host}/login";
        var dict = new Dictionary<string, string>();
        dict.Add("client_id", _config.LoginPageDiscordClientId.ToString());
        dict.Add("client_secret", _config.LoginPageDiscordClientSecret);
        dict.Add("grant_type", "authorization_code");
        dict.Add("code", code);
        dict.Add("redirect_uri", redirectUrl);
        using var requestMessage = new HttpRequestMessage(HttpMethod.Post, "https://discordapp.com/api/oauth2/token") {Content = new FormUrlEncodedContent(dict)};
        var response = _client.Send(requestMessage);
        var reader = new StreamReader(response.Content.ReadAsStream());
        var responseFromServer = reader.ReadToEnd();
        var token = JsonSerializer.Deserialize<Oauth.Token>(responseFromServer);
        HttpContext.Session.SetObjectAsJson("accessToken", token.AccessToken);
        Response.Redirect("/");
    }
}