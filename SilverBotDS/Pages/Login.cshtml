@page "/login"
@using System.Net
@using System.Text
@using System.IO
@using Microsoft.AspNetCore.Http
@using SilverBotDS.Objects
@using DSharpPlus
@using System.Diagnostics
@using SilverBotDS.WebHelpers

@using System.Net.Http
@using System.Net.Http.Headers
@inject IHttpContextAccessor HttpContextAccessor
@inject Config config
@inject HttpClient client
@{
    string code = Request.Query["code"].ToString();
    if (string.IsNullOrEmpty(code))
    {
        Response.Redirect(config.LoginPageDiscordRedirectUrl);
    }
    else
    {
        //stolen from https://www.yogihosting.com/discord-api-asp-net/
        string redirect_url = $"https://{Request.Host}/login";
        var dict = new Dictionary<string, string>();
        dict.Add("client_id", config.LoginPageDiscordClientId.ToString());
        dict.Add("client_secret", config.LoginPageDiscordClientSecret.ToString());
        dict.Add("grant_type", "authorization_code");
        dict.Add("code", code);
        dict.Add("redirect_uri", redirect_url);
        using var requestMessage = new HttpRequestMessage(HttpMethod.Post, "https://discordapp.com/api/oauth2/token") {Content = new FormUrlEncodedContent(dict) };
        var response = client.Send(requestMessage);
        StreamReader reader = new StreamReader(response.Content.ReadAsStream());
        string responseFromServer = reader.ReadToEnd();
        var token = System.Text.Json.JsonSerializer.Deserialize<SilverBotDS.Objects.Classes.Oauth.Token>(responseFromServer);
        SessionHelper.SetObjectAsJson(HttpContext.Session, "accessToken", token.AccessToken);
        Response.Redirect("/");
    }
}